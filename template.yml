Transform: AWS::Serverless-2016-10-31

Parameters:
  SteamApiKey:
    Type: AWS::SSM::Parameter::Value<String>
  CorsOrigins:
    Type: CommaDelimitedList
  ServerHost:
    Type: String
  KeyAdminUsername:
    Type: String
    Description: IAM name of user that will admin the key

Globals:
  Function:
    Runtime: java11
    MemorySize: 2048
    Environment:
      Variables:
        AUTH_KEY_ID: !Ref EncryptionKey
        GAMES_TABLE: !Ref Games
        ACHIEVEMENTS_TABLE: !Ref Achievements
        STEAM_API_KEY: !Ref SteamApiKey
        CORS_ORIGINS: !Join [ ',', !Ref CorsOrigins ]
        JOBS_TABLE: !Ref Jobs
        SERVER_HOST: !Ref ServerHost

Resources:
  Api:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowCredentials: true
        AllowHeaders: [ Authorization ]
        AllowMethods: [ GET, POST ]
        AllowOrigins: !Ref CorsOrigins
        ExposeHeaders: [ '*' ]
      DisableExecuteApiEndpoint: true

  SyncWorker:
    Type: 'AWS::Serverless::Function'
    Properties:
      Timeout: 60
      Handler: io.andrewohara.cheetosbros.sync.SyncLambdaHandler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref Games
        - DynamoDBCrudPolicy:
            TableName: !Ref Achievements
        - DynamoDBCrudPolicy:
            TableName: !Ref Jobs
      Events:
        WorkQueue:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt Jobs.StreamArn
            StartingPosition: TRIM_HORIZON
            BatchSize: 5

  ApiHandler:
    Type: 'AWS::Serverless::Function'
    Properties:
      Timeout: 10
      Handler: io.andrewohara.cheetosbros.api.ApiLambdaHandler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref Games
        - DynamoDBReadPolicy:
            TableName: !Ref Achievements
        - DynamoDBCrudPolicy:
            TableName: !Ref Jobs
        - KMSEncryptPolicy:
            KeyId: !Ref EncryptionKey
        - KMSDecryptPolicy:
            KeyId: !Ref EncryptionKey
      Events:
        HttpApiEvent:
          Type: HttpApi
          Properties:
            ApiId: !Ref Api

  EncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      KeyPolicy:
        Version: 2012-10-17
        Id: key-default-1
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource: '*'
          - Sid: Allow administration of the key
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:user/${KeyAdminUsername}
            Action:
              - kms:*
            Resource: '*'
      KeySpec: RSA_2048
      KeyUsage: ENCRYPT_DECRYPT

  Games:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: id
          KeyType: RANGE

  Achievements:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: libraryId
          AttributeType: S
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: libraryId
          KeyType: HASH
        - AttributeName: id
          KeyType: RANGE

  Jobs:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: gameId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: gameId
          KeyType: RANGE
      StreamSpecification:
        StreamViewType: NEW_IMAGE
      TimeToLiveSpecification:
        AttributeName: expires
        Enabled: true
